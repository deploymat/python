# Configuration
ENV_FILE=.env
COMPOSE=docker-compose --env-file $(ENV_FILE)
PROJECT_NAME=myapi
DOMAIN=api.example.com

# ğŸ› ï¸ Build and Start
up:
	@echo "ğŸš€ Starting services..."
	$(COMPOSE) up -d --build

# ğŸ›‘ Stop Services
down:
	@echo "ğŸ›‘ Stopping services..."
	$(COMPOSE) down

# ğŸ”„ Restart services
restart: down up

# ğŸ§¼ Clean up containers and images
clean:
	@echo "ğŸ§½ Cleaning up..."
	$(COMPOSE) down --volumes --remove-orphans
	docker rmi $$(docker images -f "dangling=true" -q) 2>/dev/null || true

# ğŸ“œ View logs
logs:
	@echo "ğŸ“„ Showing logs (API and Caddy)..."
	$(COMPOSE) logs -f $(PROJECT_NAME) caddy

logs-api:
	$(COMPOSE) logs -f $(PROJECT_NAME)

logs-caddy:
	$(COMPOSE) logs -f caddy

# ğŸš Open shell inside API container
shell:
	docker exec -it $(PROJECT_NAME) /bin/sh

# ğŸ“¡ Create Docker network (first-time setup)
network:
	docker network create web || true

# ğŸ§ª Health check
health:
	curl -s https://$(DOMAIN) || echo "âŒ Service not responding"

# ğŸ†˜ Help
help:
	@echo ""
	@echo "ğŸ› ï¸  Available commands:"
	@echo "  make up         â€“ Build and start services"
	@echo "  make down       â€“ Stop services"
	@echo "  make restart    â€“ Restart services"
	@echo "  make clean      â€“ Stop and remove all containers, volumes, and dangling images"
	@echo "  make logs       â€“ Show logs for API and Caddy"
	@echo "  make logs-api   â€“ Show logs only for API"
	@echo "  make logs-caddy â€“ Show logs only for Caddy"
	@echo "  make shell      â€“ Open shell in API container"
	@echo "  make network    â€“ Create shared Docker network (web)"
	@echo "  make health     â€“ Check public API response"
	@echo ""
